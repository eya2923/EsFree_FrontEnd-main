trigger:
  branches:
    include:
      - master

pool:
  name: default

stages:

  - stage: analyse_sonarcloud
    displayName: 'Analyze with SonarCloud'
    jobs:
      - job: sonarcloud_analysis
        displayName: 'SonarCloud Analysis'
        steps:
          - checkout: self
            fetchDepth: 0

          - task: SonarCloudPrepare@2
            inputs:
              SonarCloud: 'sonarcloud'
              organization: 'projetdevsecops'
              scannerMode: 'CLI'
              configMode: 'manual'
              cliProjectKey: 'hadillabidi_DevSecOps'
              cliProjectName: 'DevSecOps'
              cliSources: '.'

          - task: SonarCloudAnalyze@2
            displayName: 'Run SonarCloud Analysis'

  - stage: build_docker_image
    jobs:
      - job: build_image
        displayName: 'Build Docker Image'
        steps:
          - script: |
              docker build -t myimage:latest .
            displayName: 'Build Docker Image'

      - job: publish_quality_gate
        displayName: 'Publish Quality Gate Result'
        dependsOn: build_image
        steps:
          - task: SonarCloudPublish@1
            inputs:
              pollingTimeoutSec: '300'
            displayName: 'Publish Quality Gate Result'
