trigger:
  branches:
    include:
      - master

pr: none # for test for manual run only

pool:
  name: default

stages:
  - stage: analyse_build_and_sonarcloud
    displayName: 'Prepare, Build, and Analyze with SonarCloud'
    jobs:
      - job: prepare_build_analyze
        displayName: 'Prepare, Build, and Analyze'
        steps:
          - checkout: self
            fetchDepth: 0
          
          # Step 1: Prepare SonarCloud Analysis
          - task: SonarCloudPrepare@2
            inputs:
              SonarCloud: 'sonarcloud'
              organization: 'sonareya'
              scannerMode: 'CLI' # Changed to CLI for Node.js projects
              configMode: 'manual'
              cliProjectKey: 'breya0105_devsecops'
              cliProjectName: 'devsecops'
              cliSources: '.'
              extraProperties: |
                sonar.projectKey=breya0105_devsecops
                sonar.organization=sonareya

          # Step 2: Install Node.js and build application
          - task: NodeTool@0
            inputs:
              versionSpec: '18.x'
            displayName: 'Install Node.js for frontend'

          # Verify Node.js and npm installation
          - script: |
              node -v
              npm -v
            displayName: 'Verify Node.js and npm version'

          # Clean npm cache
          - script: npm cache clean --force
            displayName: 'Clean npm cache'

          # Install project dependencies
          - script: npm install --legacy-peer-deps
            displayName: 'Install project dependencies'

          # Install Angular CLI globally
          - script: npm install -g @angular/cli
            displayName: 'Install Angular CLI globally'

          # Build the application
          - script: npm run build
            displayName: 'Build Application'

          # Step 3: Run SonarCloud Analysis
          - task: SonarCloudAnalyze@2
            inputs:
              jdkVersion: 'JAVA_HOME_17_X64' # Adjust or remove if not needed

          # Optional: Publish results (use SonarCloudPublish if you need to publish results)
          - task: SonarCloudPublish@1
            inputs:
              pollingTimeoutSec: '300' # Only if this task is available and needed
